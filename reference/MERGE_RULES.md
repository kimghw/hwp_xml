# 테이블 병합 규칙

## 개요

Base 파일(원본)의 테이블에 Add 파일(추가 데이터)의 내용을 병합합니다.
병합은 `input_` 필드가 있는 영역에만 데이터를 추가하며, 기존 데이터(`data_`)는 유지됩니다.

## 파일 구분

| 구분 | 설명 |
|------|------|
| Base 파일 | 원본 HWPX 파일. 테이블 구조와 필드명(nc_name)이 설정된 템플릿 |
| Add 파일 | 추가할 데이터가 있는 파일. Base와 동일한 필드명 구조 |

## 접두사별 병합 동작

| 접두사 | 병합 시 동작 | 설명 |
|--------|-------------|------|
| `header_` | 유지 | 테이블 헤더. 변경 없음 |
| `data_` | 유지 | 기존 데이터. 변경 없음 |
| `add_` | 내용 추가 | 기존 셀 텍스트 뒤에 새 내용 추가 (행 추가 없음) |
| `stub_` | 새 행 생성 | 행 헤더. 데이터 추가 시 새 행 생성 |
| `gstub_` | rowspan 확장 | 그룹 헤더. 같은 값이면 rowspan 확장, 다른 값이면 새 셀 생성 |
| `input_` | 데이터 입력 | 빈 셀에 데이터 입력. 빈 셀 없으면 새 행 추가 |

## 병합 로직 상세

### 1. 기본 흐름

```
1. Base 파일에서 테이블 구조 파싱
2. Add 파일에서 input_ 필드 데이터 추출
3. 필드명 매칭으로 데이터 병합
4. 필요시 행 추가 (gstub_ rowspan 확장 포함)
```

### 2. input_ 필드 처리

```
┌──────────┬──────────┬──────────┐
│ header_A │ header_B │ header_C │  ← 유지
├──────────┼──────────┼──────────┤
│ gstub_X  │ input_1  │ input_2  │  ← 빈 셀이면 데이터 입력
│ (병합)   │          │          │
├──────────┼──────────┼──────────┤
│          │ input_1  │ input_2  │  ← gstub 영역 내 추가 행
├──────────┼──────────┼──────────┤
│ stub_Y   │ input_1  │ input_2  │  ← stub는 새 행 생성
└──────────┴──────────┴──────────┘
```

### 3. gstub_ 처리 규칙

**같은 gstub 값인 경우:**
- 기존 gstub 셀의 rowspan 확장
- 새 행에는 gstub 셀 없음 (rowspan으로 커버)

**다른 gstub 값인 경우:**
- 새 gstub 셀 생성
- rowspan=1로 시작, 이후 같은 값이면 확장

```
Before:                          After (같은 값 추가):
┌────────┬────────┐              ┌────────┬────────┐
│ gstub  │ input  │              │ gstub  │ data1  │
│ "A"    │        │              │ "A"    ├────────┤
│        │        │              │(rs=2)  │ data2  │  ← 새 행, gstub rowspan 확장
└────────┴────────┘              └────────┴────────┘

After (다른 값 추가):
┌────────┬────────┐
│ gstub  │ data1  │
│ "A"    │        │
├────────┼────────┤
│ gstub  │ data2  │  ← 새 gstub 셀 생성
│ "B"    │        │
└────────┴────────┘
```

### 4. stub_ 처리 규칙

stub_는 항상 새 행을 생성합니다.

```
Before:                          After:
┌────────┬────────┐              ┌────────┬────────┐
│ stub_X │ input  │              │ stub_X │ data1  │
└────────┴────────┘              ├────────┼────────┤
                                 │ stub_X │ data2  │  ← 새 행 + stub 복사
                                 └────────┴────────┘
```

### 5. 중첩 stub/gstub 처리

여러 stub/gstub가 연속으로 있는 경우:

```
┌──────────┬──────────┬──────────┬──────────┐
│ gstub_A  │ stub_B   │ input_1  │ input_2  │
│ (2행병합)│          │          │          │
├──────────┼──────────┼──────────┼──────────┤
│          │ stub_C   │ input_1  │ input_2  │
└──────────┴──────────┴──────────┴──────────┘
```

데이터 추가 시:
- `gstub_A`가 같으면 rowspan 확장
- `stub_B`, `stub_C`는 각각 새 행 생성

## 데이터 매칭 규칙

### 필드명 기준 매칭

Add 파일의 input_ 데이터는 Base 파일의 동일한 필드명 위치에 매칭됩니다.

```python
# Add 파일 데이터 예시
add_data = {
    "input_abc123": "새 데이터1",
    "input_def456": "새 데이터2",
    "gstub_xyz789": "그룹A",  # gstub 값도 포함
}
```

### 그룹화된 input_ 처리

동일한 필드명을 가진 input_ 셀들은 같은 열에 데이터가 들어갑니다.

```
Base 테이블:
┌──────────┬──────────┐
│ stub_X   │ input_1  │  ← input_1 (row 1)
├──────────┼──────────┤
│ stub_Y   │ input_1  │  ← input_1 (row 2), 같은 필드명
└──────────┴──────────┘

Add 데이터: [{"input_1": "A"}, {"input_1": "B"}]

결과:
┌──────────┬──────────┐
│ stub_X   │ A        │
├──────────┼──────────┤
│ stub_Y   │ B        │
└──────────┴──────────┘
```

## 사용법

```python
from merge.table_merger import TableMerger

# 1. Base 파일 로드
merger = TableMerger()
merger.load_base_table("base.hwpx", table_index=0)

# 2. Add 데이터 준비
add_data = [
    {"gstub_abc": "그룹A", "input_123": "값1", "input_456": "값2"},
    {"gstub_abc": "그룹A", "input_123": "값3", "input_456": "값4"},  # gstub 확장
    {"gstub_abc": "그룹B", "input_123": "값5", "input_456": "값6"},  # 새 gstub
]

# 3. 병합 실행
merger.merge_with_stub(add_data)

# 4. 저장
merger.save("output.hwpx")
```

## 병합 모드

| 모드 | 설명 |
|------|------|
| `fill_empty` | 빈 input_ 셀만 채움, 행 추가 안 함 |
| `append_row` | 항상 새 행 추가 |
| `smart` | 빈 셀 먼저 채우고, 부족하면 행 추가 (기본값) |

## 제약 사항

1. **data_ 셀은 변경 불가**: 기존 데이터 보존
2. **header_ 셀은 변경 불가**: 테이블 구조 유지
3. **colspan은 유지**: 병합된 열 구조 유지
4. **필드명 일치 필요**: Base와 Add의 필드명이 일치해야 매칭
